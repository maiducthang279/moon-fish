(function(){"use strict";const F=(t,n)=>({x:t.x+n.x,y:t.y+n.y}),T=(t,n)=>({x:t.x-n.x,y:t.y-n.y}),_=(t,n)=>{const a=Math.hypot(t.x,t.y);return{x:t.x/a*n,y:t.y/a*n}},X=(t,n)=>Math.hypot(t.x,t.y)>n?_(t,n):t,A=Math.PI/3,V=(t,n,a)=>{const c=Math.atan2(a.y,a.x),e=[],s=t[0],o=n[0],I=7,P=[1,1.05,1.22,1.4,1.22,1.05,1],h=[Math.PI/2,Math.PI/3,Math.PI/6,0,-Math.PI/6,-Math.PI/3,-Math.PI/2],l=Array.from({length:I},(m,D)=>{const E=h[D];return i(o*P[D],c+E,s)});e.push(...l);const r=[],M=[];for(let m=1;m<t.length;m++){const D=t[m],E=n[m],S=t[m-1],L=Math.atan2(S.y-D.y,S.x-D.x),B=i(E,L+Math.PI/2,D),G=i(E,L-Math.PI/2,D);r.push(B),M.push(G)}const y=t[t.length-1],d=n[n.length-1],x=t[t.length-2],f=Math.atan2(x.y-y.y,x.x-y.x),u=i(d,f+Math.PI,y);return e.push(...M),e.push(u),e.push(...r.reverse()),e},i=(t,n,a)=>({x:a.x+t*Math.cos(n),y:a.y+t*Math.sin(n)}),v=(t,n,a)=>{const{positions:c,velocity:e}=t,s={...c[0]},o=Math.min(n,a)/4,I=t.phaseDelay||0,P=Math.floor((performance.now()-I)/500),h=Math.floor(P%30/10)-1,l=Math.floor(P%50/10)-2,r={x:n/2+h*o/3,y:a/2+l*o/6},M={minX:r.x-o,minY:r.y-o,maxX:r.x+o,maxY:r.y+o},y=g(Math.atan2(e.y,e.x)),d=g(Math.atan2(r.y-s.y,r.x-s.x)),x=g(d-y);if(s.x>M.minX&&s.x<M.maxX&&s.y>M.minY&&s.y<M.maxY){const f=Math.hypot(r.x-s.x,r.y-s.y),u=A*(o-f)/o,m=x<Math.PI?u:Math.PI*(2-u);return i(10*2,y-m,s)}if(x<Math.PI/2||x>Math.PI*3/2)return r;if(x>Math.PI/2&&x<Math.PI*3/2){const f=x<Math.PI?A:Math.PI*(2-A);return i(10*2,y+f,s)}return r},N=(t,n,a)=>{const{positions:c,velocity:e}=t,s=v(t,n,a),o=T(s,c[0]),P=X(_(o,10),.5),h=X(F(e,P),10),l=c.map((M,y,d)=>{if(y===0)return F(M,h);const x=d[y-1],f=d[y-2];return R(M,x,f)});return{...t,velocity:h,acceleration:P,positions:l,vertexes:{...t.vertexes,body:V(l,t.widths,h).map(M=>[M.x,M.y]).flat(),fins:O(l,t.widths),dorsal:Z(l,h,t.widths),tail:H(l,t.widths),eyes:p(l,t.widths,Math.atan2(h.y,h.x))}}},R=(t,n,a)=>{const c=b(t,n,70);if(!a)return c;const e=Y(c,n,a,A);return{x:n.x+Math.cos(e)*70,y:n.y+Math.sin(e)*70}},b=(t,n,a)=>{const c=Math.atan2(t.y-n.y,t.x-n.x);return{x:n.x+a*Math.cos(c),y:n.y+a*Math.sin(c)}},Y=(t,n,a,c)=>{const e=t.x-n.x,s=t.y-n.y,o=Math.atan2(s,e),I=n.x-a.x,P=n.y-a.y,h=Math.atan2(P,I),l=C(o,h);return Math.abs(l)<=c?g(o):l>c?g(h-c):g(h+c)},C=(t,n)=>{const a=g(t+Math.PI-n);return Math.PI-a},g=t=>{const n=Math.PI*2;let a=t;for(;a<0;)a+=n;for(;a>n;)a-=n;return a},w=(t,n)=>Math.atan2(t.y-n.y,t.x-n.x),K=(t,n,a,c=50)=>{const e=g(w(t,n)),s=g(w(a,n)),o=g(s-e)-Math.PI/2,I=g(e-s)-Math.PI/2,P=o/5,h=I/5,l=t,r=c*1.8,M=e+Math.PI/2+I/3,y=e-Math.PI/2-o/3,d=[t,i(r,M,l),i(r*1.5,M+P,l),i(r*1.2,M+P*2,l),n].map(f=>[f.x,f.y]).flat(),x=[t,i(r,y,l),i(r*1.5,y-h,l),i(r*1.2,y-h*2,l),n].map(f=>[f.x,f.y]).flat();return[d,x]},W=(t,n)=>{const a=g(n-t),c=a>Math.PI?1-(a-Math.PI)/Math.PI:a/Math.PI;return{angleDiff:a,angleDiffPercent:c}},Z=(t,n,a)=>{const e=t.length-2,s=Math.floor((e-1)/2)+1,o=t.slice(1,e),I=t[e],P=t[s],h=g(Math.atan2(n.y,n.x)),l=g(Math.atan2(t[e-1].y-I.y,t[e-1].x-I.x)),{angleDiff:r,angleDiffPercent:M}=W(h,l),y=r>Math.PI?h-Math.PI*2/3:h+Math.PI*2/3,d=i(a[s]*.8*M,y,P);return[...o,d].map(x=>[x.x,x.y]).flat()},H=(t,n)=>{const c=g(w(t[0],t[1])),e=t[t.length-1],s=t[t.length-2],o=Math.atan2(s.y-e.y,s.x-e.x),I=i(n[t.length-1],o+Math.PI,e),P=i(100*1.8/3,o+Math.PI,I),h=i(100*2/3,o+Math.PI,I),{angleDiff:l,angleDiffPercent:r}=W(c,o),M=l>Math.PI?o-Math.PI/2:o+Math.PI/2,y=r,d=M+Math.PI,x=M;return[e,i(100*y,d,h),P,i(100/2*y,x,h)].map(u=>[u.x,u.y]).flat()},O=(t,n)=>[...[0,3].map(c=>{const e=t[c],s=t[c+1],o=t[c+2];return K(e,s,o,n[c])}).flat()],p=(t,n,a)=>[i(n[0]*.8,a-Math.PI*.4,t[0]),i(n[0]*.8,a+Math.PI*.4,t[0])];self.onmessage=t=>{const{fishes:n,width:a,height:c}=t.data,e=n.map(s=>N(s,a,c));self.postMessage(e)}})();
